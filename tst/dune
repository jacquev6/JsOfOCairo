; Copyright 2017-2018 Vincent Jacques <vincent@vincent-jacques.net>

(executable
  (name tests_in_native)
  (modules tests_in_native)
  (libraries Tests cairo2)
;  (preprocess (pps bisect_ppx)); Uncomment for dev mode
)

(rule
  (targets tests_in_native.sentinel)
  (deps tests_in_native.exe)
  (action (progn
    (run %{bin:mkdir} -p Tests/Drawing/Cairo)
    (run %{bin:mkdir} -p Tests/Limitations)
    (run %{exe:tests_in_native.exe})
    (write-file tests_in_native.sentinel sentinel)
  ))
)

(alias
  (name runtest)
  (deps tests_in_native.sentinel)
)


(rule
  (targets node_modules.sentinel)
  (deps npm-install.sh)
  (action (progn
    (system "./npm-install.sh 'canvas@>=1.6.10 <2' 'pixelmatch@>=4.0.2 <5' browserify")
    (write-file node_modules.sentinel sentinel)
  ))
)


; tests_in_node can't run during `opam install JsOfOCairo --build-test`:
; with opam 2, the sandbox mode forbids downloading npm dependencies.
; So, we use the runtest-full alias to run them in our dev cycle script

(executable
  (name tests_in_node)
  (modules tests_in_node)
  (libraries Tests JsOfOCairo)
  (preprocess (pps js_of_ocaml-ppx))
  (js_of_ocaml (flags ("+nat.js")))
)

(rule
  (targets tests_in_node.sentinel)
  (deps node_modules.sentinel tests_in_node.bc.js tests_in_native.sentinel)
  (action (progn
    (run %{bin:mkdir} -p Tests/Drawing/JsOfOCairo)
    (run %{bin:node} tests_in_node.bc.js)
    (write-file tests_in_node.sentinel sentinel)
  ))
)

(alias
  (name runtest-full)
  (deps tests_in_node.sentinel)
)


(rule
  (targets pixelmatch.js)
  (deps node_modules.sentinel)
  (action (progn
    (with-stdout-to %{targets} (system "node_modules/.bin/browserify -s pixelmatch node_modules/pixelmatch/index.js"))
  ))
)

(executable
  (name tests_in_browser)
  (modules tests_in_browser)
  (libraries Tests JsOfOCairo)
  (preprocess (pps js_of_ocaml-ppx))
  (js_of_ocaml (flags ("+nat.js")))
)

(alias
  (name runtest-full)
  (deps tests_in_browser.html pixelmatch.js tests_in_browser.bc.js tests_in_native.sentinel)
)
